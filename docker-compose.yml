# Docker Compose configuration for osmo-remsim
#
# This file provides easy deployment of the remsim infrastructure:
# - remsim-server: Central server managing SIM slot mappings
# - remsim-bankd: SIM bank daemon with USB smart card reader access
#
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose up -d server       # Start only server
#   docker-compose up -d bankd        # Start only bankd
#   docker-compose logs -f            # View logs
#   docker-compose down               # Stop all services
#
# For USB access (octosim reader), make sure your user has access to
# /dev/bus/usb devices or run with sudo.

services:
  # Central remsim-server
  # Manages slot mappings between clients and SIM bank slots
  server:
    build: .
    image: osmo-remsim:latest
    container_name: remsim-server
    command: server
    ports:
      - "9997:9997"  # REST API
      - "9998:9998"  # RSPRO protocol
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9997/api/backend/slotmaps"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # SIM bank daemon with USB smart card reader access
  # Connects to server and provides access to physical SIM cards
  bankd:
    build: .
    image: osmo-remsim:latest
    container_name: remsim-bankd
    command: bankd
    privileged: true  # Required for USB access
    volumes:
      - /dev/bus/usb:/dev/bus/usb  # USB device access for smart card readers
      - ./bankd_pcsc_slots.csv:/etc/osmocom/bankd_pcsc_slots.csv:ro  # Optional slot configuration
    ports:
      - "9999:9999"  # RSPRO protocol (bankd <-> clients)
    environment:
      - REMSIM_SERVER_HOST=server
      - REMSIM_SERVER_PORT=9998
      - REMSIM_BANK_ID=1
      - REMSIM_NUM_SLOTS=8
    depends_on:
      server:
        condition: service_healthy
    restart: unless-stopped

  # Combined server + bankd (for simple testing setups)
  all-in-one:
    build: .
    image: osmo-remsim:latest
    container_name: remsim-all
    command: all
    privileged: true
    volumes:
      - /dev/bus/usb:/dev/bus/usb
      - ./bankd_pcsc_slots.csv:/etc/osmocom/bankd_pcsc_slots.csv:ro
    ports:
      - "9997:9997"
      - "9998:9998"
      - "9999:9999"
    environment:
      - REMSIM_BANK_ID=1
      - REMSIM_NUM_SLOTS=8
    restart: unless-stopped
    profiles:
      - all-in-one  # Only start with: docker-compose --profile all-in-one up

# Network for inter-container communication
networks:
  default:
    name: remsim-network
