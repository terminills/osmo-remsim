<%#
Copyright (C) 2024 OpenWRT
Licensed under GNU General Public License v2
-%>

<%+header%>

<h2 name="content"><%:Remote SIM Client Status%></h2>

<style>
.status-card {
	background: #fff;
	border: 1px solid #ddd;
	border-radius: 4px;
	padding: 15px;
	margin-bottom: 15px;
}
.status-card h3 {
	margin-top: 0;
	border-bottom: 1px solid #eee;
	padding-bottom: 10px;
}
.status-indicator {
	display: inline-block;
	width: 12px;
	height: 12px;
	border-radius: 50%;
	margin-right: 8px;
}
.status-running { background-color: #5cb85c; }
.status-stopped { background-color: #d9534f; }
.status-warning { background-color: #f0ad4e; }
.info-row {
	display: flex;
	padding: 8px 0;
	border-bottom: 1px solid #f5f5f5;
}
.info-label {
	font-weight: bold;
	width: 200px;
}
.info-value {
	flex: 1;
	font-family: monospace;
}
.action-buttons {
	margin-top: 15px;
}
.btn {
	display: inline-block;
	padding: 8px 16px;
	margin-right: 10px;
	border: none;
	border-radius: 4px;
	cursor: pointer;
	text-decoration: none;
	color: #fff;
}
.btn-primary { background-color: #337ab7; }
.btn-success { background-color: #5cb85c; }
.btn-danger { background-color: #d9534f; }
.btn-warning { background-color: #f0ad4e; }
</style>

<!-- Service Status Card -->
<div class="status-card">
	<h3><%:Service Status%></h3>
	<div class="info-row">
		<div class="info-label"><%:Status%>:</div>
		<div class="info-value">
			<% if service_status.running then %>
				<span class="status-indicator status-running"></span>
				<strong><%:Running%></strong> (PID: <%=service_status.pid%>)
			<% else %>
				<span class="status-indicator status-stopped"></span>
				<strong><%:Stopped%></strong>
			<% end %>
		</div>
	</div>
	<div class="info-row">
		<div class="info-label"><%:Autostart%>:</div>
		<div class="info-value">
			<%= service_status.enabled and "Enabled" or "Disabled" %>
		</div>
	</div>
	
	<div class="action-buttons">
		<a href="<%=url('admin/services/remsim/action_restart')%>" class="btn btn-warning">
			<%:Restart Service%>
		</a>
		<a href="javascript:testConnection()" class="btn btn-primary">
			<%:Test Connection%>
		</a>
	</div>
</div>

<!-- Client Information Card -->
<div class="status-card">
	<h3><%:Client Information%></h3>
	<div class="info-row">
		<div class="info-label"><%:Client ID%>:</div>
		<div class="info-value"><%=client_info.client_id%></div>
	</div>
	<div class="info-row">
		<div class="info-label"><%:Client Slot%>:</div>
		<div class="info-value"><%=client_info.client_slot%></div>
	</div>
	<div class="info-row">
		<div class="info-label"><%:Mapping Mode%>:</div>
		<div class="info-value"><%=client_info.mapping_mode%></div>
	</div>
	<div class="info-row">
		<div class="info-label"><%:Dual-Modem Mode%>:</div>
		<div class="info-value">
			<%= client_info.dual_modem and "Enabled" or "Disabled" %>
		</div>
	</div>
</div>

<!-- IonMesh Status Card -->
<% if ionmesh_status.enabled then %>
<div class="status-card">
	<h3><%:IonMesh Orchestration%></h3>
	<div class="info-row">
		<div class="info-label"><%:Status%>:</div>
		<div class="info-value">
			<% if ionmesh_status.reachable then %>
				<span class="status-indicator status-running"></span>
				<strong><%:Connected%></strong>
			<% else %>
				<span class="status-indicator status-warning"></span>
				<strong><%:Unreachable%></strong>
			<% end %>
		</div>
	</div>
	<div class="info-row">
		<div class="info-label"><%:Host%>:</div>
		<div class="info-value"><%=ionmesh_status.host%>:<%=ionmesh_status.port%></div>
	</div>
</div>
<% end %>

<!-- Statistics Card -->
<% if statistics.available or service_status.running then %>
<div class="status-card">
	<h3><%:Client Statistics%></h3>
	<div class="info-row">
		<div class="info-label"><%:Uptime%>:</div>
		<div class="info-value" data-stat-uptime><%=statistics.uptime%></div>
	</div>
	<div class="info-row">
		<div class="info-label"><%:TPDUs Sent%>:</div>
		<div class="info-value" data-stat-tpdus_sent><%=statistics.tpdus_sent%></div>
	</div>
	<div class="info-row">
		<div class="info-label"><%:TPDUs Received%>:</div>
		<div class="info-value" data-stat-tpdus_received><%=statistics.tpdus_received%></div>
	</div>
	<div class="info-row">
		<div class="info-label"><%:Errors%>:</div>
		<div class="info-value">
			<% if statistics.errors > 0 then %>
				<span style="color: #d9534f; font-weight: bold;" data-stat-errors><%=statistics.errors%></span>
			<% else %>
				<span data-stat-errors><%=statistics.errors%></span>
			<% end %>
		</div>
	</div>
	<div class="info-row">
		<div class="info-label"><%:Reconnections%>:</div>
		<div class="info-value" data-stat-reconnections><%=statistics.reconnections%></div>
	</div>
	<div class="info-row">
		<div class="info-label"><%:SIM Switches%>:</div>
		<div class="info-value" data-stat-sim_switches><%=statistics.sim_switches%></div>
	</div>
	
	<div class="action-buttons">
		<a href="javascript:printStats()" class="btn btn-primary">
			<%:Refresh Statistics%>
		</a>
	</div>
</div>
<% end %>

<!-- Signal Strength Card -->
<% if signal_status.enabled and service_status.running then %>
<div class="status-card">
	<h3><%:Signal Strength Monitoring%></h3>
	<div class="info-row">
		<div class="info-label"><%:Monitoring%>:</div>
		<div class="info-value">
			<span class="status-indicator status-running"></span>
			<strong><%:Enabled%></strong> (every <%=signal_status.interval%> seconds)
		</div>
	</div>
	<% if signal_status.last_rssi then %>
	<div class="info-row">
		<div class="info-label"><%:Last Signal (RSSI)%>:</div>
		<div class="info-value">
			<strong style="font-size: 1.2em;" data-signal-rssi><%=signal_status.last_rssi%> dBm</strong>
			<span style="margin-left: 10px;">
				<% if signal_status.last_rssi >= -70 then %>
					<span class="status-indicator status-running"></span>Excellent
				<% elseif signal_status.last_rssi >= -85 then %>
					<span class="status-indicator status-warning"></span>Good
				<% elseif signal_status.last_rssi >= -100 then %>
					<span class="status-indicator status-warning"></span>Fair
				<% else %>
					<span class="status-indicator status-stopped"></span>Poor
				<% end %>
			</span>
		</div>
	</div>
	<% if signal_status.last_check then %>
	<div class="info-row">
		<div class="info-label"><%:Last Check%>:</div>
		<div class="info-value"><%=signal_status.last_check%></div>
	</div>
	<% end %>
	<% else %>
	<div class="info-row">
		<div class="info-label"><%:Status%>:</div>
		<div class="info-value">
			<span class="status-indicator status-warning"></span>
			<em>Waiting for signal data...</em>
		</div>
	</div>
	<% end %>
</div>
<% end %>

<!-- Modem Status Card -->
<div class="status-card">
	<h3><%:Modem Status%></h3>
	
	<% if client_info.dual_modem then %>
		<!-- Modem 1 -->
		<h4><%:Modem 1 (Primary/Remote SIM)%></h4>
		<div class="info-row">
			<div class="info-label"><%:Device%>:</div>
			<div class="info-value"><%=modem_status.modem1.device%></div>
		</div>
		<div class="info-row">
			<div class="info-label"><%:Present%>:</div>
			<div class="info-value">
				<% if modem_status.modem1.present then %>
					<span class="status-indicator status-running"></span>Yes
				<% else %>
					<span class="status-indicator status-stopped"></span>No
				<% end %>
			</div>
		</div>
		<% if modem_status.modem1.present then %>
		<div class="info-row">
			<div class="info-label"><%:Info%>:</div>
			<div class="info-value"><pre><%=modem_status.modem1.info%></pre></div>
		</div>
		<% end %>
		
		<br/>
		
		<!-- Modem 2 -->
		<h4><%:Modem 2 (Always-On IoT)%></h4>
		<div class="info-row">
			<div class="info-label"><%:Device%>:</div>
			<div class="info-value"><%=modem_status.modem2.device%></div>
		</div>
		<div class="info-row">
			<div class="info-label"><%:Present%>:</div>
			<div class="info-value">
				<% if modem_status.modem2.present then %>
					<span class="status-indicator status-running"></span>Yes
				<% else %>
					<span class="status-indicator status-stopped"></span>No
				<% end %>
			</div>
		</div>
		<% if modem_status.modem2.present then %>
		<div class="info-row">
			<div class="info-label"><%:Info%>:</div>
			<div class="info-value"><pre><%=modem_status.modem2.info%></pre></div>
		</div>
		<% end %>
		
	<% else %>
		<!-- Single Modem -->
		<div class="info-row">
			<div class="info-label"><%:Device%>:</div>
			<div class="info-value"><%=modem_status.single.device%></div>
		</div>
		<div class="info-row">
			<div class="info-label"><%:Present%>:</div>
			<div class="info-value">
				<% if modem_status.single.present then %>
					<span class="status-indicator status-running"></span>Yes
				<% else %>
					<span class="status-indicator status-stopped"></span>No
				<% end %>
			</div>
		</div>
		<% if modem_status.single.present then %>
		<div class="info-row">
			<div class="info-label"><%:Info%>:</div>
			<div class="info-value"><pre><%=modem_status.single.info%></pre></div>
		</div>
		<% end %>
	<% end %>
</div>

<script>
function testConnection() {
	var xhr = new XHR();
	xhr.get('<%=url("admin/services/remsim/action_test")%>', null, function(x, data) {
		alert('Connection Test Result:\n\n' + data);
	});
}

function printStats() {
	var xhr = new XHR();
	xhr.get('<%=url("admin/services/remsim/action_print_stats")%>', null, function(x, data) {
		alert(data);
		// Reload page after a short delay to show updated stats
		setTimeout(function() {
			window.location.reload();
		}, 2000);
	});
}

// Auto-refresh signal strength every 30 seconds
<% if signal_status.enabled and service_status.running then %>
setInterval(function() {
	var xhr = new XHR();
	xhr.get('<%=url("admin/services/remsim/action_get_signal")%>', null, function(x, data) {
		if (data) {
			try {
				var signal = JSON.parse(data);
				if (signal.last_rssi) {
					// Update signal display if element exists
					var signalElements = document.querySelectorAll('[data-signal-rssi]');
					signalElements.forEach(function(el) {
						el.textContent = signal.last_rssi + ' dBm';
					});
				}
			} catch(e) {
				console.error('Failed to parse signal data:', e);
			}
		}
	});
}, 30000);
<% end %>

// Auto-refresh statistics every 60 seconds
<% if statistics.available or service_status.running then %>
setInterval(function() {
	var xhr = new XHR();
	xhr.get('<%=url("admin/services/remsim/action_get_stats")%>', null, function(x, data) {
		if (data) {
			try {
				var stats = JSON.parse(data);
				// Update statistics display if elements exist
				var statsElements = {
					'uptime': stats.uptime,
					'tpdus_sent': stats.tpdus_sent,
					'tpdus_received': stats.tpdus_received,
					'errors': stats.errors,
					'reconnections': stats.reconnections,
					'sim_switches': stats.sim_switches
				};
				
				for (var key in statsElements) {
					var el = document.querySelector('[data-stat-' + key + ']');
					if (el) {
						el.textContent = statsElements[key];
					}
				}
			} catch(e) {
				console.error('Failed to parse statistics data:', e);
			}
		}
	});
}, 60000);
<% end %>
</script>

<%+footer%>
